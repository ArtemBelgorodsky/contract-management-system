<template>
  <div class="min-h-screen bg-neutral">
    <Header />

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
        <p class="text-neutral-darker mt-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</p>
      </div>

      <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
        <div class="card">
          <div class="card-body text-center">
            <div class="text-4xl font-bold text-primary mb-2">{{ stats.total }}</div>
            <p class="text-sm text-neutral-darker">–í—Å–µ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</p>
          </div>
        </div>

        <div class="card">
          <div class="card-body text-center">
            <div class="text-3xl font-bold text-green-500 mb-2">{{ stats.byStatus.approved }}</div>
            <p class="text-sm text-neutral-darker">–û–¥–æ–±—Ä–µ–Ω–æ</p>
          </div>
        </div>

        <div class="card">
          <div class="card-body text-center">
            <div class="text-3xl font-bold text-yellow-500 mb-2">{{ stats.byStatus.submitted }}</div>
            <p class="text-sm text-neutral-darker">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</p>
          </div>
        </div>

        <div class="card">
          <div class="card-body text-center">
            <div class="text-3xl font-bold text-red-500 mb-2">{{ stats.byStatus.rejected }}</div>
            <p class="text-sm text-neutral-darker">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</p>
          </div>
        </div>

        <div class="card">
          <div class="card-body text-center">
            <div class="text-3xl font-bold text-blue-500 mb-2">{{ stats.byStatus.draft }}</div>
            <p class="text-sm text-neutral-darker">–ß–µ—Ä–Ω–æ–≤–∏–∫</p>
          </div>
        </div>
      </div>

      <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <RouterLink
          to="/admin/contracts"
          class="card hover:shadow-lg transition-shadow cursor-pointer"
        >
          <div class="card-body">
            <div class="text-4xl mb-3">üìã</div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤</h3>
            <p class="text-neutral-darker text-sm">
              {{ stats.byStatus.submitted }} –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∂–¥—É—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
            </p>
          </div>
        </RouterLink>

        <RouterLink
          to="/admin/catalog"
          class="card hover:shadow-lg transition-shadow cursor-pointer"
        >
          <div class="card-body">
            <div class="text-4xl mb-3">üìö</div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">–ö–∞—Ç–∞–ª–æ–≥ —Ç–∏–ø–æ–≤</h3>
            <p class="text-neutral-darker text-sm">
              {{ catalogTypes.length }} —Ç–∏–ø–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–æ–≤
            </p>
          </div>
        </RouterLink>

        <RouterLink
          to="/profile"
          class="card hover:shadow-lg transition-shadow cursor-pointer"
        >
          <div class="card-body">
            <div class="text-4xl mb-3">üë§</div>
            <h3 class="text-lg font-bold text-gray-900 mb-2">–ü—Ä–æ—Ñ–∏–ª—å</h3>
            <p class="text-neutral-darker text-sm">
              –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ—Ñ–∏–ª—è
            </p>
          </div>
        </RouterLink>
      </div>

      <!-- –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="card">
          <div class="card-header">
            <h2 class="text-lg font-bold text-gray-900">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
          </div>
          <div class="divide-y divide-neutral-dark max-h-96 overflow-y-auto">
            <div
              v-if="auditLogs.length === 0"
              class="p-6 text-center text-neutral-darker"
            >
              –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø—É—Å—Ç–∞
            </div>

            <div
              v-for="log in auditLogs.slice(0, 10)"
              :key="log.id"
              class="px-6 py-4 hover:bg-neutral transition-colors"
            >
              <div class="flex items-center justify-between mb-2">
                <p class="font-medium text-gray-900">{{ getActionLabel(log.action) }}</p>
                <span :class="getActionBadgeClass(log.action)" class="badge text-xs">
                  {{ getEntityTypeLabel(log.entityType) }}
                </span>
              </div>
              <p class="text-xs text-neutral-darker">
                {{ formatDate(log.timestamp) }}
              </p>
            </div>
          </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∏–ø–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ -->
        <div class="card">
          <div class="card-header">
            <h2 class="text-lg font-bold text-gray-900">üìä –¢–∏–ø—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤</h2>
          </div>
          <div class="divide-y divide-neutral-dark max-h-96 overflow-y-auto">
            <div
              v-if="catalogTypes.length === 0"
              class="p-6 text-center text-neutral-darker"
            >
              –¢–∏–ø–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –Ω–µ—Ç
            </div>

            <div
              v-for="type in catalogTypes"
              :key="type.id"
              class="px-6 py-4 hover:bg-neutral transition-colors flex items-center justify-between"
            >
              <div>
                <p class="font-medium text-gray-900">{{ type.name }}</p>
                <p class="text-xs text-neutral-darker">{{ type.description }}</p>
              </div>
              <span class="badge badge-primary">{{ getContractCountByType(type.id) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- –°–ø—Ä–∞–≤–∫–∞ -->
      <div class="card mt-6">
        <div class="card-header">
          <h2 class="text-lg font-bold text-gray-900">‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞</h2>
        </div>
        <div class="card-body">
          <div class="space-y-3 text-sm text-neutral-darker">
            <p>
              <span class="font-semibold text-gray-900">–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤:</span>
              –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤" —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏ –æ–¥–æ–±—Ä–∏—Ç—å/–æ—Ç–∫–ª–æ–Ω–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
            </p>
            <p>
              <span class="font-semibold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–º:</span>
              –í —Ä–∞–∑–¥–µ–ª–µ "–ö–∞—Ç–∞–ª–æ–≥ —Ç–∏–ø–æ–≤" –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ —É–¥–∞–ª—è—Ç—å —Ç–∏–ø—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤.
            </p>
            <p>
              <span class="font-semibold text-gray-900">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π:</span>
              –í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –¥–ª—è –∞—É–¥–∏—Ç–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è.
            </p>
            <p>
              <span class="font-semibold text-gray-900">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</span>
              –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–≤–æ–∏—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤.
            </p>
          </div>
        </div>
      </div>
    </main>
  </div>
</template>

<script setup lang="ts">
import { computed, onMounted } from 'vue'
import { useContractsStore } from '@/stores/contractsStore'
import { useCatalogStore } from '@/stores/catalogStore'
import { useAuditStore } from '@/stores/auditStore'
import Header from '@/components/Header.vue'

const contractsStore = useContractsStore()
const catalogStore = useCatalogStore()
const auditStore = useAuditStore()

const stats = computed(() => contractsStore.getContractStats())
const catalogTypes = computed(() => catalogStore.contractTypes)
const auditLogs = computed(() => auditStore.auditLogs)

const getContractCountByType = (typeId: string) => {
  return contractsStore.contracts.filter(c => c.typeId === typeId).length
}

const getActionLabel = (action: string) => {
  const labels: Record<string, string> = {
    create: '–°–æ–∑–¥–∞–Ω–æ',
    update: '–û–±–Ω–æ–≤–ª–µ–Ω–æ',
    delete: '–£–¥–∞–ª–µ–Ω–æ',
    approve: '–û–¥–æ–±—Ä–µ–Ω–æ',
    reject: '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
  }
  return labels[action] || action
}

const getEntityTypeLabel = (entityType: string) => {
  const labels: Record<string, string> = {
    contract: '–î–æ–≥–æ–≤–æ—Ä',
    contract_type: '–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞',
    catalog: '–ö–∞—Ç–∞–ª–æ–≥'
  }
  return labels[entityType] || entityType
}

const getActionBadgeClass = (action: string) => {
  if (['approve', 'create', 'update'].includes(action)) {
    return 'badge-success'
  }
  if (action === 'reject' || action === 'delete') {
    return 'badge-danger'
  }
  return 'badge-primary'
}

const formatDate = (date: Date | string) => {
  return new Date(date).toLocaleDateString('ru-RU', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })
}

onMounted(() => {
  contractsStore.fetchContracts()
  catalogStore.fetchContractTypes()
})
</script>
